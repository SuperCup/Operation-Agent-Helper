# 待完善功能实现方案与执行计划

## 一、功能概述

当前系统已完成核心交互流程和UI组件，但部分功能仍使用模拟数据。本文档详细说明待完善功能的实现方案。

## 二、待完善功能清单

### 2.1 实际Agent API调用
**当前状态**：使用模拟数据和简单的关键词匹配  
**目标**：对接真实的AI Agent API，实现意图识别和任务执行

### 2.2 工作流执行引擎
**当前状态**：仅显示UI，无实际执行逻辑  
**目标**：实现完整的工作流执行引擎，支持步骤编排、状态管理、错误处理

### 2.3 文件上传处理
**当前状态**：仅前端处理，文件存储在内存中  
**目标**：实现文件上传到服务器，支持文件存储、预览、下载

### 2.4 文档生成服务
**当前状态**：仅创建任务，无实际生成逻辑  
**目标**：实现PPT/Excel/Doc的实际生成功能

### 2.5 意图识别Agent
**当前状态**：使用关键词匹配模拟  
**目标**：实现独立的意图识别Agent调用

---

## 三、详细实现方案

### 3.1 实际Agent API调用

#### 3.1.1 架构设计

```
┌─────────────────────────────────────────┐
│         前端 (React)                     │
│  ┌───────────────────────────────────┐  │
│  │  AgentService (API调用封装)        │  │
│  └───────────────────────────────────┘  │
└──────────────┬──────────────────────────┘
               │ HTTP/WebSocket
┌──────────────▼──────────────────────────┐
│      后端API服务 (Node.js/Python)        │
│  ┌───────────────────────────────────┐  │
│  │  Agent Gateway (路由/鉴权)        │  │
│  └──────────────┬────────────────────┘  │
│                 │                        │
│  ┌──────────────▼────────────────────┐  │
│  │  Intent Recognition Agent         │  │
│  │  Operation Plan Agent             │  │
│  │  Budget Split Agent               │  │
│  │  ... (其他Agent)                   │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

#### 3.1.2 技术方案

**方案A：RESTful API（推荐用于同步调用）**
- 优点：简单、易调试、支持标准HTTP
- 缺点：长任务需要轮询
- 适用场景：意图识别、快速响应任务

**方案B：WebSocket（推荐用于长任务）**
- 优点：实时双向通信、支持流式输出
- 缺点：连接管理复杂
- 适用场景：工作流执行、文档生成

**方案C：混合方案（推荐）**
- 意图识别、快速任务：RESTful API
- 工作流执行、文档生成：WebSocket
- 文件上传：RESTful API（支持分片上传）

#### 3.1.3 API设计

**意图识别API**
```typescript
POST /api/agents/intent/recognize
Request: {
  message: string;
  sessionId?: string;
  context?: {
    history?: Message[];
    attachments?: Attachment[];
  };
}
Response: {
  intent: IntentType | null;
  confidence: number;
  summary: string;
  recommendedAgents?: string[];
  reasoning?: string; // Agent思考过程
}
```

**Agent执行API**
```typescript
POST /api/agents/{agentId}/execute
Request: {
  taskId: string;
  params: Record<string, any>;
  workflowTemplateId?: string;
}
Response: {
  taskId: string;
  workflowId: string;
  status: 'running' | 'completed' | 'failed';
  estimatedDuration?: number;
}
```

**工作流状态查询API**
```typescript
GET /api/workflows/{workflowId}
Response: {
  id: string;
  status: string;
  steps: WorkflowStep[];
  currentStep?: string;
  progress: number;
}
```

**WebSocket消息格式**
```typescript
// 客户端发送
{
  type: 'start_workflow',
  workflowId: string;
  taskId: string;
}

// 服务端推送
{
  type: 'step_started' | 'step_completed' | 'step_failed' | 'workflow_completed',
  stepId: string;
  stepName: string;
  progress: number;
  output?: any;
  thinking?: string; // Agent思考过程
  logs?: string[];
}
```

#### 3.1.4 实现步骤

1. **创建API服务层**
   - 文件：`src/services/agentService.ts`
   - 功能：封装所有Agent API调用
   - 包含：请求拦截、错误处理、重试机制

2. **创建WebSocket服务**
   - 文件：`src/services/websocketService.ts`
   - 功能：管理WebSocket连接、消息处理
   - 包含：自动重连、心跳检测、消息队列

3. **更新EnhancedAIChatBox**
   - 替换模拟的意图识别为真实API调用
   - 集成WebSocket接收工作流执行更新

4. **错误处理与降级**
   - API失败时显示友好错误提示
   - 网络错误时自动重试（最多3次）
   - 支持离线模式（使用本地缓存）

#### 3.1.5 依赖项

- HTTP客户端：`axios` 或 `fetch`
- WebSocket客户端：原生 `WebSocket` 或 `socket.io-client`
- 状态管理：已使用 `zustand`

---

### 3.2 工作流执行引擎

#### 3.2.1 架构设计

```
┌─────────────────────────────────────────┐
│      工作流执行引擎                       │
│  ┌───────────────────────────────────┐  │
│  │  Workflow Engine (核心引擎)        │  │
│  │  - 步骤编排                         │  │
│  │  - 状态管理                         │  │
│  │  - 依赖解析                         │  │
│  └──────────────┬────────────────────┘  │
│                 │                        │
│  ┌──────────────▼────────────────────┐  │
│  │  Step Executor (步骤执行器)        │  │
│  │  - Agent调用                       │  │
│  │  - 工具调用                         │  │
│  │  - 人工确认                         │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

#### 3.2.2 核心功能

1. **步骤编排**
   - 解析工作流模板，构建执行计划
   - 处理步骤依赖关系（顺序执行/并行执行）
   - 支持条件分支（if/else）

2. **状态管理**
   - 工作流状态：idle → running → paused → completed/failed
   - 步骤状态：pending → running → success/failed → waiting_human
   - 状态持久化（支持断点续传）

3. **执行控制**
   - 开始/暂停/恢复/取消
   - 错误重试（可配置重试次数）
   - 超时处理

4. **人工介入**
   - 检测需要人工确认的步骤
   - 暂停工作流，等待用户输入
   - 用户确认后继续执行

#### 3.2.3 实现方案

**方案A：前端执行（简单场景）**
- 优点：实现简单，无需后端
- 缺点：无法处理复杂逻辑，受限于浏览器环境
- 适用：简单的顺序执行工作流

**方案B：后端执行（推荐）**
- 优点：功能完整，支持复杂逻辑，可扩展
- 缺点：需要后端服务
- 适用：生产环境

**方案C：混合方案**
- 简单步骤：前端执行
- 复杂步骤：后端执行
- 实时同步：WebSocket

#### 3.2.4 数据结构

```typescript
interface WorkflowExecution {
  id: string;
  templateId: string;
  taskId: string;
  status: 'idle' | 'running' | 'paused' | 'completed' | 'failed';
  currentStepId?: string;
  steps: WorkflowStepExecution[];
  context: Record<string, any>; // 工作流上下文数据
  createdAt: Date;
  updatedAt: Date;
}

interface WorkflowStepExecution {
  id: string;
  stepTemplateId: string;
  status: StepStatus;
  progress: number;
  input?: any;
  output?: any;
  error?: string;
  thinking?: string; // Agent思考过程
  logs: string[];
  startTime?: Date;
  endTime?: Date;
  retryCount: number;
}
```

#### 3.2.5 实现步骤

1. **创建工作流引擎核心类**
   - 文件：`src/services/workflowEngine.ts`
   - 功能：工作流执行逻辑

2. **实现步骤执行器**
   - 文件：`src/services/stepExecutor.ts`
   - 功能：单个步骤的执行逻辑

3. **集成到EnhancedAIChatBox**
   - 工作流启动时调用引擎
   - 实时更新执行状态
   - 处理人工确认节点

4. **状态持久化**
   - 工作流状态保存到localStorage或后端
   - 支持刷新页面后恢复

#### 3.2.6 依赖项

- 工作流引擎库（可选）：`@temporalio/client` 或自研
- 状态管理：已使用 `zustand`

---

### 3.3 文件上传处理

#### 3.3.1 架构设计

```
┌─────────────────────────────────────────┐
│         前端上传                          │
│  - 文件选择                               │
│  - 分片上传（大文件）                     │
│  - 进度显示                               │
└──────────────┬──────────────────────────┘
               │ HTTP POST/Multipart
┌──────────────▼──────────────────────────┐
│      后端文件服务                         │
│  - 文件接收                               │
│  - 文件存储（本地/OSS/S3）               │
│  - 文件元数据管理                         │
└─────────────────────────────────────────┘
```

#### 3.3.2 技术方案

**文件存储方案**

**方案A：本地存储（开发/小规模）**
- 存储位置：服务器本地文件系统
- 优点：简单、无需额外服务
- 缺点：扩展性差、单点故障
- 适用：开发环境、小规模部署

**方案B：对象存储（生产环境推荐）**
- 存储位置：阿里云OSS / 腾讯云COS / AWS S3
- 优点：高可用、可扩展、CDN加速
- 缺点：需要配置、有成本
- 适用：生产环境

**方案C：混合方案**
- 小文件（<10MB）：本地存储
- 大文件（≥10MB）：对象存储

#### 3.3.3 API设计

**文件上传API**
```typescript
POST /api/files/upload
Content-Type: multipart/form-data
Request: {
  file: File;
  sessionId?: string;
  taskId?: string;
  type?: 'reference' | 'material' | 'data';
}
Response: {
  fileId: string;
  url: string;
  previewUrl?: string;
  name: string;
  size: number;
  type: string;
  uploadedAt: Date;
}
```

**文件预览API**
```typescript
GET /api/files/{fileId}/preview
Response: {
  url: string;
  type: string;
}
```

**文件下载API**
```typescript
GET /api/files/{fileId}/download
Response: File stream
```

#### 3.3.4 实现步骤

1. **创建文件上传服务**
   - 文件：`src/services/fileService.ts`
   - 功能：文件上传、预览、下载

2. **实现分片上传（大文件）**
   - 文件：`src/utils/chunkUpload.ts`
   - 功能：大文件分片、断点续传

3. **更新InfoCollectionModal**
   - 集成真实文件上传
   - 显示上传进度
   - 错误处理

4. **文件管理**
   - 文件列表展示
   - 文件删除
   - 文件预览（图片、PDF等）

#### 3.3.5 依赖项

- 文件上传：原生 `FormData` 或 `react-dropzone`
- 进度显示：自定义或使用库
- 文件预览：根据类型使用不同预览组件

---

### 3.4 文档生成服务

#### 3.4.1 架构设计

```
┌─────────────────────────────────────────┐
│      文档生成服务                         │
│  ┌───────────────────────────────────┐  │
│  │  Document Generator               │  │
│  │  - PPT生成器                       │  │
│  │  - Excel生成器                     │  │
│  │  - Doc生成器                       │  │
│  └──────────────┬────────────────────┘  │
│                 │                        │
│  ┌──────────────▼────────────────────┐  │
│  │  Template Engine (模板引擎)        │  │
│  │  - 模板管理                         │  │
│  │  - 数据填充                         │  │
│  │  - 样式渲染                         │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

#### 3.4.2 技术方案

**PPT生成方案**

**方案A：使用库生成（推荐）**
- 前端：`pptxgenjs`（纯前端生成）
- 后端：`python-pptx`（Python）或 `officegen`（Node.js）
- 优点：可控性强、样式丰富
- 缺点：需要编写模板代码

**方案B：使用模板文件**
- 准备PPT模板文件
- 使用库填充数据
- 优点：样式统一、易维护
- 缺点：需要设计模板

**Excel生成方案**
- 前端：`xlsx` 或 `exceljs`
- 后端：`openpyxl`（Python）或 `exceljs`（Node.js）
- 优点：功能完整、性能好

**Doc生成方案**
- 前端：`docx`（有限）
- 后端：`python-docx`（Python）或 `docx`（Node.js）
- 优点：格式控制精确

#### 3.4.3 实现方案

**推荐：后端生成（生产环境）**
- 原因：性能好、功能完整、安全性高
- 流程：
  1. 前端发起生成请求
  2. 后端接收任务和数据
  3. 后端生成文档
  4. 文档存储到对象存储
  5. 返回下载链接

**备选：前端生成（简单场景）**
- 原因：无需后端、实时生成
- 限制：功能有限、性能受限

#### 3.4.4 API设计

**文档生成API**
```typescript
POST /api/documents/generate
Request: {
  type: 'ppt' | 'excel' | 'doc';
  sourceTaskId: string;
  templateId?: string;
  data: Record<string, any>;
  options?: {
    format?: string;
    style?: string;
  };
}
Response: {
  taskId: string;
  status: 'pending' | 'generating';
  estimatedDuration?: number;
}
```

**文档生成状态查询**
```typescript
GET /api/documents/{taskId}
Response: {
  taskId: string;
  status: 'pending' | 'generating' | 'completed' | 'failed';
  progress: number;
  result?: {
    url: string;
    previewUrl?: string;
    size: number;
  };
  error?: string;
}
```

#### 3.4.5 实现步骤

1. **创建文档生成服务**
   - 文件：`src/services/documentService.ts`
   - 功能：调用后端API、状态查询

2. **实现文档模板**
   - 创建PPT/Excel/Doc模板文件
   - 定义数据填充规则

3. **更新QuickActionsBar**
   - 集成真实文档生成API
   - 显示生成进度

4. **文档预览功能**
   - PPT预览：转换为图片或使用在线预览
   - Excel预览：在线表格查看器
   - Doc预览：PDF转换或在线预览

#### 3.4.6 依赖项

- 文档生成库：根据方案选择
- 文件存储：对象存储服务
- 预览服务：在线预览API或自建

---

### 3.5 意图识别Agent

#### 3.5.1 架构设计

```
┌─────────────────────────────────────────┐
│      意图识别Agent                       │
│  ┌───────────────────────────────────┐  │
│  │  Intent Recognition Model        │  │
│  │  - 文本理解                        │  │
│  │  - 意图分类                        │  │
│  │  - 置信度计算                      │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

#### 3.5.2 技术方案

**方案A：使用大语言模型（推荐）**
- 模型：GPT-4 / Claude / 文心一言
- 方式：Prompt Engineering
- 优点：准确率高、易扩展
- 缺点：有成本、需要API调用

**方案B：使用分类模型**
- 模型：BERT / RoBERTa（微调）
- 方式：训练意图分类模型
- 优点：速度快、成本低
- 缺点：需要训练数据、扩展性差

**方案C：混合方案**
- 快速路径：关键词匹配（简单场景）
- 复杂路径：LLM调用（复杂场景）
- 优点：兼顾速度和准确性

#### 3.5.3 Prompt设计

```typescript
const INTENT_RECOGNITION_PROMPT = `
你是一个意图识别专家。请分析用户的输入，识别用户的意图。

可用的意图类型：
1. operation_plan - 运营方案生成
2. budget_split - 预算拆分
3. activity_config - 活动配置
4. activity_ops - 活动运营
5. rtb_plan - RTB方案
6. rtb_config - RTB配置
7. rtb_ops - RTB运营

用户输入：{userInput}

请以JSON格式返回：
{
  "intent": "意图类型或null",
  "confidence": 0.0-1.0,
  "summary": "用户意图摘要",
  "reasoning": "识别理由"
}
`;
```

#### 3.5.4 实现步骤

1. **创建意图识别服务**
   - 文件：`src/services/intentService.ts`
   - 功能：调用意图识别API

2. **实现Prompt模板**
   - 文件：`src/prompts/intentRecognition.ts`
   - 功能：定义Prompt模板

3. **更新EnhancedAIChatBox**
   - 替换关键词匹配为API调用
   - 处理识别结果

4. **缓存机制**
   - 相同输入缓存结果
   - 减少API调用

#### 3.5.5 依赖项

- LLM API：OpenAI / Anthropic / 其他
- 缓存：内存缓存或Redis

---

## 四、执行计划

### 4.1 优先级划分

**P0（核心功能，必须实现）**
1. 实际Agent API调用（基础）
2. 工作流执行引擎（核心）
3. 文件上传处理（必需）

**P1（重要功能，建议实现）**
4. 意图识别Agent（提升体验）
5. 文档生成服务（完整功能）

**P2（优化功能，可选实现）**
6. 文档预览优化
7. 缓存机制
8. 性能优化

### 4.2 实施阶段

#### 阶段一：基础API集成（1-2周）
**目标**：建立前后端通信基础

**任务清单**：
1. 搭建后端API服务（Node.js/Python）
2. 实现基础API接口（意图识别、Agent执行）
3. 前端集成API调用
4. 错误处理和重试机制

**交付物**：
- 后端API服务
- 前端API服务层
- 基础功能测试通过

#### 阶段二：工作流引擎（2-3周）
**目标**：实现完整的工作流执行能力

**任务清单**：
1. 设计工作流执行引擎架构
2. 实现步骤编排逻辑
3. 实现状态管理和持久化
4. 实现人工确认机制
5. WebSocket实时通信
6. 错误处理和重试

**交付物**：
- 工作流执行引擎
- 实时状态更新
- 完整测试用例

#### 阶段三：文件处理（1周）
**目标**：实现文件上传和管理

**任务清单**：
1. 实现文件上传API
2. 集成对象存储（或本地存储）
3. 实现文件预览
4. 实现文件管理（列表、删除）

**交付物**：
- 文件上传功能
- 文件管理功能

#### 阶段四：文档生成（1-2周）
**目标**：实现文档生成服务

**任务清单**：
1. 选择文档生成方案
2. 实现文档生成API
3. 创建文档模板
4. 实现文档预览
5. 集成到快捷功能

**交付物**：
- 文档生成服务
- 文档预览功能

#### 阶段五：意图识别优化（1周）
**目标**：提升意图识别准确性

**任务清单**：
1. 实现LLM调用
2. 优化Prompt设计
3. 实现缓存机制
4. 性能优化

**交付物**：
- 意图识别Agent
- 缓存机制

### 4.3 技术选型建议

#### 后端技术栈
- **Node.js + Express**（推荐，与前端技术栈一致）
- **Python + FastAPI**（备选，AI生态丰富）

#### 数据库
- **PostgreSQL**（关系型数据）
- **Redis**（缓存、会话存储）

#### 文件存储
- **开发环境**：本地文件系统
- **生产环境**：阿里云OSS / 腾讯云COS

#### AI服务
- **意图识别**：OpenAI GPT-4 / Claude
- **Agent执行**：自建Agent服务或使用Agent框架

### 4.4 风险评估

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| API调用失败 | 高 | 中 | 实现重试机制、降级方案 |
| 工作流执行中断 | 高 | 低 | 状态持久化、断点续传 |
| 文件上传失败 | 中 | 中 | 分片上传、断点续传 |
| 文档生成性能 | 中 | 中 | 异步处理、队列机制 |
| 成本控制 | 中 | 高 | 缓存、限流、成本监控 |

### 4.5 测试计划

1. **单元测试**：API服务、工具函数
2. **集成测试**：前后端联调
3. **端到端测试**：完整流程测试
4. **性能测试**：并发、压力测试
5. **用户体验测试**：真实场景验证

---

## 五、确认事项

### 5.1 技术选型确认

- [ ] 后端技术栈：Node.js 还是 Python？
- [ ] 文件存储：本地存储 还是 对象存储？
- [ ] 文档生成：前端生成 还是 后端生成？
- [ ] AI服务：使用哪个LLM API？

### 5.2 功能范围确认

- [ ] 是否需要支持工作流的条件分支？
- [ ] 是否需要支持并行步骤执行？
- [ ] 文档生成是否需要支持自定义模板？
- [ ] 是否需要文件版本管理？

### 5.3 优先级确认

- [ ] 是否同意P0/P1/P2的优先级划分？
- [ ] 是否需要调整实施阶段顺序？
- [ ] 是否有时间限制？

### 5.4 其他需求

- [ ] 是否需要用户认证和授权？
- [ ] 是否需要多租户支持？
- [ ] 是否需要数据统计和分析？

---

**文档版本**：v1.0  
**创建日期**：2026-01-28  
**最后更新**：2026-01-28
